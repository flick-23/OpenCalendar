import{w as C,g as Se}from"./BDaeVcD9.js";import{S as ee,e as K,b as Te,f as k,t as S,u as Ae,c as L,w as Ke,E as se,d as Oe,P as me,r as be,h as te,s as O,A as le,g as ke}from"./B8oHrQjp.js";import{s as Ce}from"./BFOVJj18.js";var M=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},p=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},x,N,P,I;function ce(r){return r!==null&&typeof r=="object"}class w{constructor(e){if(x.set(this,void 0),N.set(this,void 0),e.byteLength!==w.RAW_KEY_LENGTH)throw new Error("An Ed25519 public key must be exactly 32bytes long");M(this,x,L(e),"f"),M(this,N,w.derEncode(e),"f")}static from(e){if(typeof e=="string"){const t=k(e);return this.fromRaw(t)}else if(ce(e)){const t=e;if(ce(t)&&Object.hasOwnProperty.call(t,"__derEncodedPublicKey__"))return this.fromDer(t);if(ArrayBuffer.isView(t)){const n=t;return this.fromRaw(L(n.buffer))}else{if(t instanceof ArrayBuffer)return this.fromRaw(t);if("rawKey"in t)return this.fromRaw(t.rawKey);if("derKey"in t)return this.fromDer(t.derKey);if("toDer"in t)return this.fromDer(t.toDer())}}throw new Error("Cannot construct Ed25519PublicKey from the provided key.")}static fromRaw(e){return new w(e)}static fromDer(e){return new w(this.derDecode(e))}static derEncode(e){const t=Ke(e,se).buffer;return t.__derEncodedPublicKey__=void 0,t}static derDecode(e){const t=Oe(e,se);if(t.length!==this.RAW_KEY_LENGTH)throw new Error("An Ed25519 public key must be exactly 32bytes long");return L(t)}get rawKey(){return p(this,x,"f")}get derKey(){return p(this,N,"f")}toDer(){return this.derKey}toRaw(){return this.rawKey}}x=new WeakMap,N=new WeakMap;w.RAW_KEY_LENGTH=32;class _ extends ee{constructor(e,t){super(),P.set(this,void 0),I.set(this,void 0),M(this,P,w.from(e),"f"),M(this,I,new Uint8Array(t),"f")}static generate(e){if(e&&e.length!==32)throw new Error("Ed25519 Seed needs to be 32 bytes long.");e||(e=K.utils.randomPrivateKey()),Te(e,new Uint8Array(new Array(32).fill(0)))&&console.warn("Seed is all zeros. This is not a secure seed. Please provide a seed with sufficient entropy if this is a production environment.");const t=new Uint8Array(32);for(let i=0;i<32;i++)t[i]=new Uint8Array(e)[i];const n=K.getPublicKey(t);return _.fromKeyPair(n,t)}static fromParsedJson(e){const[t,n]=e;return new _(w.fromDer(k(t)),k(n))}static fromJSON(e){const t=JSON.parse(e);if(Array.isArray(t)){if(typeof t[0]=="string"&&typeof t[1]=="string")return this.fromParsedJson([t[0],t[1]]);throw new Error("Deserialization error: JSON must have at least 2 items.")}throw new Error(`Deserialization error: Invalid JSON type for string: ${JSON.stringify(e)}`)}static fromKeyPair(e,t){return new _(w.fromRaw(e),t)}static fromSecretKey(e){const t=K.getPublicKey(new Uint8Array(e));return _.fromKeyPair(t,e)}toJSON(){return[S(p(this,P,"f").toDer()),S(p(this,I,"f"))]}getKeyPair(){return{secretKey:p(this,I,"f"),publicKey:p(this,P,"f")}}getPublicKey(){return p(this,P,"f")}async sign(e){const t=new Uint8Array(e),n=Ae(K.sign(t,p(this,I,"f").slice(0,32)));return Object.defineProperty(n,"__signature__",{enumerable:!1,value:void 0}),n}static verify(e,t,n){const[i,o,s]=[e,t,n].map(a=>(typeof a=="string"&&(a=k(a)),a instanceof Uint8Array&&(a=L(a.buffer)),new Uint8Array(a)));return K.verify(i,o,s)}}P=new WeakMap,I=new WeakMap;class re extends Error{constructor(e){super(e),this.message=e,Object.setPrototypeOf(this,re.prototype)}}function de(r){if(typeof global<"u"&&global.crypto&&global.crypto.subtle)return global.crypto.subtle;if(r)return r;if(typeof crypto<"u"&&crypto.subtle)return crypto.subtle;throw new re("Global crypto was not available and none was provided. Please inlcude a SubtleCrypto implementation. See https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto")}class U extends ee{constructor(e,t,n){super(),this._keyPair=e,this._derKey=t,this._subtleCrypto=n}static async generate(e){const{extractable:t=!1,keyUsages:n=["sign","verify"],subtleCrypto:i}=e??{},o=de(i),s=await o.generateKey({name:"ECDSA",namedCurve:"P-256"},t,n),a=await o.exportKey("spki",s.publicKey);return new this(s,a,o)}static async fromKeyPair(e,t){const n=de(t),i=await n.exportKey("spki",e.publicKey);return new U(e,i,n)}getKeyPair(){return this._keyPair}getPublicKey(){const e=this._derKey,t=Object.create(this._keyPair.publicKey);return t.toDer=function(){return e},t}async sign(e){const t={name:"ECDSA",hash:{name:"SHA-256"}};return await this._subtleCrypto.sign(t,this._keyPair.privateKey,e)}}var Le=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},D=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},g;class xe{constructor(e){g.set(this,void 0),Le(this,g,e,"f")}get rawKey(){return D(this,g,"f").rawKey}get derKey(){return D(this,g,"f").derKey}toDer(){return D(this,g,"f").toDer()}getPublicKey(){return D(this,g,"f")}getPrincipal(){if(!D(this,g,"f").rawKey)throw new Error("Cannot get principal from a public key without a raw key.");return me.fromUint8Array(new Uint8Array(D(this,g,"f").rawKey))}transformRequest(){return Promise.reject("Not implemented. You are attempting to use a partial identity to sign calls, but this identity only has access to the public key.To sign calls, use a DelegationIdentity instead.")}}g=new WeakMap;var Ne=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},Re=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Be=function(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(r);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(r,n[i])&&(t[n[i]]=r[n[i]]);return t},R;const je=new TextEncoder().encode("ic-request-auth-delegation"),Me=new TextEncoder().encode(`
ic-request`);function J(r){if(typeof r!="string"||r.length<64)throw new Error("Invalid public key.");return k(r)}class ne{constructor(e,t,n){this.pubkey=e,this.expiration=t,this.targets=n}toCBOR(){return O.value.map(Object.assign({pubkey:O.value.bytes(this.pubkey),expiration:O.value.u64(this.expiration.toString(16),16)},this.targets&&{targets:O.value.array(this.targets.map(e=>O.value.bytes(te(e.toUint8Array()))))}))}toJSON(){return Object.assign({expiration:this.expiration.toString(16),pubkey:S(this.pubkey)},this.targets&&{targets:this.targets.map(e=>e.toHex())})}}async function Ue(r,e,t,n){const i=new ne(e.toDer(),BigInt(+t)*BigInt(1e6),n),o=new Uint8Array([...je,...new Uint8Array(be(Object.assign({},i)))]),s=await r.sign(te(o));return{delegation:i,signature:s}}class W{constructor(e,t){this.delegations=e,this.publicKey=t}static async create(e,t,n=new Date(Date.now()+15*60*1e3),i={}){var o,s;const a=await Ue(e,t,n,i.targets);return new W([...((o=i.previous)===null||o===void 0?void 0:o.delegations)||[],a],((s=i.previous)===null||s===void 0?void 0:s.publicKey)||e.getPublicKey().toDer())}static fromJSON(e){const{publicKey:t,delegations:n}=typeof e=="string"?JSON.parse(e):e;if(!Array.isArray(n))throw new Error("Invalid delegations.");const i=n.map(o=>{const{delegation:s,signature:a}=o,{pubkey:l,expiration:c,targets:u}=s;if(u!==void 0&&!Array.isArray(u))throw new Error("Invalid targets.");return{delegation:new ne(J(l),BigInt("0x"+c),u&&u.map(d=>{if(typeof d!="string")throw new Error("Invalid target.");return me.fromHex(d)})),signature:J(a)}});return new this(i,J(t))}static fromDelegations(e,t){return new this(e,t)}toJSON(){return{delegations:this.delegations.map(e=>{const{delegation:t,signature:n}=e,{targets:i}=t;return{delegation:Object.assign({expiration:t.expiration.toString(16),pubkey:S(t.pubkey)},i&&{targets:i.map(o=>o.toHex())}),signature:S(n)}}),publicKey:S(this.publicKey)}}}class ue extends ee{constructor(e,t){super(),this._inner=e,this._delegation=t}static fromDelegation(e,t){return new this(e,t)}getDelegation(){return this._delegation}getPublicKey(){return{derKey:this._delegation.publicKey,toDer:()=>this._delegation.publicKey}}sign(e){return this._inner.sign(e)}async transformRequest(e){const{body:t}=e,n=Be(e,["body"]),i=await be(t);return Object.assign(Object.assign({},n),{body:{content:t,sender_sig:await this.sign(te(new Uint8Array([...Me,...new Uint8Array(i)]))),sender_delegation:this._delegation.delegations,sender_pubkey:this._delegation.publicKey}})}}class F extends xe{constructor(e,t){super(e),R.set(this,void 0),Ne(this,R,t,"f")}get delegation(){return Re(this,R,"f")}static fromDelegation(e,t){return new F(e,t)}}R=new WeakMap;function We(r,e){for(const{delegation:n}of r.delegations)if(+new Date(Number(n.expiration/BigInt(1e6)))<=+Date.now())return!1;const t=[];for(const n of t){const i=n.toText();for(const{delegation:o}of r.delegations){if(o.targets===void 0)continue;let s=!0;for(const a of o.targets)if(a.toText()===i){s=!1;break}if(s)return!1}}return!0}var fe;(function(r){r[r.ECDSA_WITH_SHA256=-7]="ECDSA_WITH_SHA256"})(fe||(fe={}));const he=["mousedown","mousemove","keydown","touchstart","wheel"];class ye{constructor(e={}){var t;this.callbacks=[],this.idleTimeout=10*60*1e3,this.timeoutID=void 0;const{onIdle:n,idleTimeout:i=10*60*1e3}=e||{};this.callbacks=n?[n]:[],this.idleTimeout=i;const o=this._resetTimer.bind(this);window.addEventListener("load",o,!0),he.forEach(function(a){document.addEventListener(a,o,!0)});const s=(a,l)=>{let c;return(...u)=>{const d=this,y=function(){c=void 0,a.apply(d,u)};clearTimeout(c),c=window.setTimeout(y,l)}};if(e!=null&&e.captureScroll){const a=s(o,(t=e==null?void 0:e.scrollDebounce)!==null&&t!==void 0?t:100);window.addEventListener("scroll",a,!0)}o()}static create(e={}){return new this(e)}registerCallback(e){this.callbacks.push(e)}exit(){clearTimeout(this.timeoutID),window.removeEventListener("load",this._resetTimer,!0);const e=this._resetTimer.bind(this);he.forEach(function(t){document.removeEventListener(t,e,!0)}),this.callbacks.forEach(t=>t())}_resetTimer(){const e=this.exit.bind(this);window.clearTimeout(this.timeoutID),this.timeoutID=window.setTimeout(e,this.idleTimeout)}}const Fe=(r,e)=>e.some(t=>r instanceof t);let ge,we;function He(){return ge||(ge=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Je(){return we||(we=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const _e=new WeakMap,Q=new WeakMap,ve=new WeakMap,V=new WeakMap,ie=new WeakMap;function Ve(r){const e=new Promise((t,n)=>{const i=()=>{r.removeEventListener("success",o),r.removeEventListener("error",s)},o=()=>{t(v(r.result)),i()},s=()=>{n(r.error),i()};r.addEventListener("success",o),r.addEventListener("error",s)});return e.then(t=>{t instanceof IDBCursor&&_e.set(t,r)}).catch(()=>{}),ie.set(e,r),e}function ze(r){if(Q.has(r))return;const e=new Promise((t,n)=>{const i=()=>{r.removeEventListener("complete",o),r.removeEventListener("error",s),r.removeEventListener("abort",s)},o=()=>{t(),i()},s=()=>{n(r.error||new DOMException("AbortError","AbortError")),i()};r.addEventListener("complete",o),r.addEventListener("error",s),r.addEventListener("abort",s)});Q.set(r,e)}let X={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return Q.get(r);if(e==="objectStoreNames")return r.objectStoreNames||ve.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return v(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function Ge(r){X=r(X)}function Ye(r){return r===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const n=r.call(z(this),e,...t);return ve.set(n,e.sort?e.sort():[e]),v(n)}:Je().includes(r)?function(...e){return r.apply(z(this),e),v(_e.get(this))}:function(...e){return v(r.apply(z(this),e))}}function $e(r){return typeof r=="function"?Ye(r):(r instanceof IDBTransaction&&ze(r),Fe(r,He())?new Proxy(r,X):r)}function v(r){if(r instanceof IDBRequest)return Ve(r);if(V.has(r))return V.get(r);const e=$e(r);return e!==r&&(V.set(r,e),ie.set(e,r)),e}const z=r=>ie.get(r);function qe(r,e,{blocked:t,upgrade:n,blocking:i,terminated:o}={}){const s=indexedDB.open(r,e),a=v(s);return n&&s.addEventListener("upgradeneeded",l=>{n(v(s.result),l.oldVersion,l.newVersion,v(s.transaction),l)}),t&&s.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),a.then(l=>{o&&l.addEventListener("close",()=>o()),i&&l.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const Qe=["get","getKey","getAll","getAllKeys","count"],Xe=["put","add","delete","clear"],G=new Map;function pe(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(G.get(e))return G.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,i=Xe.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(i||Qe.includes(t)))return;const o=async function(s,...a){const l=this.transaction(s,i?"readwrite":"readonly");let c=l.store;return n&&(c=c.index(a.shift())),(await Promise.all([c[t](...a),i&&l.done]))[0]};return G.set(e,o),o}Ge(r=>({...r,get:(e,t,n)=>pe(e,t)||r.get(e,t,n),has:(e,t)=>!!pe(e,t)||r.has(e,t)}));const Ee="auth-client-db",De="ic-keyval",Ze=async(r=Ee,e=De,t)=>(Pe&&(localStorage!=null&&localStorage.getItem(b))&&(localStorage.removeItem(b),localStorage.removeItem(m)),await qe(r,t,{upgrade:n=>{n.objectStoreNames.contains(e)&&n.clear(e),n.createObjectStore(e)}}));async function et(r,e,t){return await r.get(e,t)}async function tt(r,e,t,n){return await r.put(e,n,t)}async function rt(r,e,t){return await r.delete(e,t)}class oe{constructor(e,t){this._db=e,this._storeName=t}static async create(e){const{dbName:t=Ee,storeName:n=De,version:i=at}=e??{},o=await Ze(t,n,i);return new oe(o,n)}async set(e,t){return await tt(this._db,this._storeName,e,t)}async get(e){var t;return(t=await et(this._db,this._storeName,e))!==null&&t!==void 0?t:null}async remove(e){return await rt(this._db,this._storeName,e)}}var nt=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},it=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},B;const m="identity",b="delegation",ot="iv",at=1,Pe=typeof window<"u";class st{constructor(e="ic-",t){this.prefix=e,this._localStorage=t}get(e){return Promise.resolve(this._getLocalStorage().getItem(this.prefix+e))}set(e,t){return this._getLocalStorage().setItem(this.prefix+e,t),Promise.resolve()}remove(e){return this._getLocalStorage().removeItem(this.prefix+e),Promise.resolve()}_getLocalStorage(){if(this._localStorage)return this._localStorage;const e=typeof window>"u"?typeof global>"u"?typeof self>"u"?void 0:self.localStorage:global.localStorage:window.localStorage;if(!e)throw new Error("Could not find local storage.");return e}}class lt{constructor(e){B.set(this,void 0),nt(this,B,e??{},"f")}get _db(){return new Promise(e=>{if(this.initializedDb){e(this.initializedDb);return}oe.create(it(this,B,"f")).then(t=>{this.initializedDb=t,e(t)})})}async get(e){return await(await this._db).get(e)}async set(e,t){await(await this._db).set(e,t)}async remove(e){await(await this._db).remove(e)}}B=new WeakMap;const ct="https://identity.internetcomputer.org",dt="#authorize",Y="ECDSA",$="Ed25519",ut=500,ft="UserInterrupt";class ht{constructor(e,t,n,i,o,s,a,l){this._identity=e,this._key=t,this._chain=n,this._storage=i,this.idleManager=o,this._createOptions=s,this._idpWindow=a,this._eventHandler=l,this._registerDefaultIdleCallback()}static async create(e={}){var t,n,i;const o=(t=e.storage)!==null&&t!==void 0?t:new lt,s=(n=e.keyType)!==null&&n!==void 0?n:Y;let a=null;if(e.identity)a=e.identity;else{let d=await o.get(m);if(!d&&Pe)try{const y=new st,H=await y.get(b),ae=await y.get(m);H&&ae&&s===Y&&(console.log("Discovered an identity stored in localstorage. Migrating to IndexedDB"),await o.set(b,H),await o.set(m,ae),d=H,await y.remove(b),await y.remove(m))}catch(y){console.error("error while attempting to recover localstorage: "+y)}if(d)try{typeof d=="object"?s===$&&typeof d=="string"?a=await _.fromJSON(d):a=await U.fromKeyPair(d):typeof d=="string"&&(a=_.fromJSON(d))}catch{}}let l=new le,c=null;if(a)try{const d=await o.get(b);if(typeof d=="object"&&d!==null)throw new Error("Delegation chain is incorrectly stored. A delegation chain should be stored as a string.");e.identity?l=e.identity:d&&(c=W.fromJSON(d),We(c)?"toDer"in a?l=F.fromDelegation(a,c):l=ue.fromDelegation(a,c):(await q(o),a=null))}catch(d){console.error(d),await q(o),a=null}let u;return!((i=e.idleOptions)===null||i===void 0)&&i.disableIdle?u=void 0:(c||e.identity)&&(u=ye.create(e.idleOptions)),a||(s===$?(a=await _.generate(),await o.set(m,JSON.stringify(a.toJSON()))):(e.storage&&s===Y&&console.warn(`You are using a custom storage provider that may not support CryptoKey storage. If you are using a custom storage provider that does not support CryptoKey storage, you should use '${$}' as the key type, as it can serialize to a string`),a=await U.generate(),await o.set(m,a.getKeyPair()))),new this(l,a,c,o,u,e)}_registerDefaultIdleCallback(){var e,t;const n=(e=this._createOptions)===null||e===void 0?void 0:e.idleOptions;!(n!=null&&n.onIdle)&&!(n!=null&&n.disableDefaultIdleCallback)&&((t=this.idleManager)===null||t===void 0||t.registerCallback(()=>{this.logout(),location.reload()}))}async _handleSuccess(e,t){var n,i;const o=e.delegations.map(c=>({delegation:new ne(c.delegation.pubkey,c.delegation.expiration,c.delegation.targets),signature:c.signature.buffer})),s=W.fromDelegations(o,e.userPublicKey.buffer),a=this._key;if(!a)return;this._chain=s,"toDer"in a?this._identity=F.fromDelegation(a,this._chain):this._identity=ue.fromDelegation(a,this._chain),(n=this._idpWindow)===null||n===void 0||n.close();const l=(i=this._createOptions)===null||i===void 0?void 0:i.idleOptions;!this.idleManager&&!(l!=null&&l.disableIdle)&&(this.idleManager=ye.create(l),this._registerDefaultIdleCallback()),this._removeEventListener(),delete this._idpWindow,this._chain&&await this._storage.set(b,JSON.stringify(this._chain.toJSON())),t==null||t(e)}getIdentity(){return this._identity}async isAuthenticated(){return!this.getIdentity().getPrincipal().isAnonymous()&&this._chain!==null}async login(e){var t,n,i,o;const s=BigInt(8)*BigInt(36e11),a=new URL(((t=e==null?void 0:e.identityProvider)===null||t===void 0?void 0:t.toString())||ct);a.hash=dt,(n=this._idpWindow)===null||n===void 0||n.close(),this._removeEventListener(),this._eventHandler=this._getEventHandler(a,Object.assign({maxTimeToLive:(i=e==null?void 0:e.maxTimeToLive)!==null&&i!==void 0?i:s},e)),window.addEventListener("message",this._eventHandler),this._idpWindow=(o=window.open(a.toString(),"idpWindow",e==null?void 0:e.windowOpenerFeatures))!==null&&o!==void 0?o:void 0;const l=()=>{this._idpWindow&&(this._idpWindow.closed?this._handleFailure(ft,e==null?void 0:e.onError):setTimeout(l,ut))};l()}_getEventHandler(e,t){return async n=>{var i,o,s;if(n.origin!==e.origin)return;const a=n.data;switch(a.kind){case"authorize-ready":{const l=Object.assign({kind:"authorize-client",sessionPublicKey:new Uint8Array((i=this._key)===null||i===void 0?void 0:i.getPublicKey().toDer()),maxTimeToLive:t==null?void 0:t.maxTimeToLive,allowPinAuthentication:t==null?void 0:t.allowPinAuthentication,derivationOrigin:(o=t==null?void 0:t.derivationOrigin)===null||o===void 0?void 0:o.toString()},t==null?void 0:t.customValues);(s=this._idpWindow)===null||s===void 0||s.postMessage(l,e.origin);break}case"authorize-client-success":try{await this._handleSuccess(a,t==null?void 0:t.onSuccess)}catch(l){this._handleFailure(l.message,t==null?void 0:t.onError)}break;case"authorize-client-failure":this._handleFailure(a.text,t==null?void 0:t.onError);break}}}_handleFailure(e,t){var n;(n=this._idpWindow)===null||n===void 0||n.close(),t==null||t(e),this._removeEventListener(),delete this._idpWindow}_removeEventListener(){this._eventHandler&&window.removeEventListener("message",this._eventHandler),this._eventHandler=void 0}async logout(e={}){if(await q(this._storage),this._identity=new le,this._chain=null,e.returnTo)try{window.history.pushState({},"",e.returnTo)}catch{window.location.href=e.returnTo}}}async function q(r){await r.remove(m),await r.remove(b),await r.remove(ot)}const T=C(!1),E=C(null),A=C(null),j=C(null),f=C(null);let h=null;const Z=async()=>{const r=Se(E);if(!r){f.set(null),console.log("No identity found, cannot fetch profile.");return}try{console.log("Fetching user profile...");const t=await(await ke(r)).get_my_profile();Array.isArray(t)&&t.length>0?(f.set(t[0]),console.log("User profile fetched and set:",t[0])):t&&!Array.isArray(t)?(f.set(t),console.log("User profile fetched and set:",t)):(f.set(null),console.log("No profile data returned or profile is empty."))}catch(e){console.error("Error fetching user profile:",e),f.set(null)}},yt=async()=>{if(h){const r=await h.isAuthenticated(),e=r?h.getIdentity():null;T.set(r),E.set(e),A.set(e?e.getPrincipal():null),j.set(h),r?await Z():f.set(null);return}try{const r=await ht.create();h=r,j.set(r);const e=await r.isAuthenticated();if(T.set(e),e){const t=r.getIdentity();E.set(t),A.set(t.getPrincipal()),await Z()}else f.set(null)}catch(r){console.error("Error initializing auth client:",r),T.set(!1),E.set(null),A.set(null),j.set(null),f.set(null)}},mt=async()=>{if(!h&&(await yt(),!h)){console.error("AuthClient not initialized, cannot login.");return}const r=h,e="http://127.0.0.1:4943/?canisterId=rdmx6-jaaaa-aaaaa-aaadq-cai";await new Promise((t,n)=>{r.login({identityProvider:e,onSuccess:async()=>{const i=r.getIdentity();E.set(i),A.set(i.getPrincipal()),T.set(!0),j.set(r),await Z(),t()},onError:i=>{console.error("Login failed:",i),T.set(!1),E.set(null),A.set(null),f.set(null),n(i)}})})},bt=async()=>{if(!h){console.error("AuthClient not initialized, cannot logout.");return}await h.logout(),T.set(!1),E.set(null),A.set(null),f.set(null)},Ie=()=>{const r=Ce;return{page:{subscribe:r.page.subscribe},navigating:{subscribe:r.navigating.subscribe},updated:r.updated}},_t={subscribe(r){return Ie().page.subscribe(r)}},vt={subscribe(r){return Ie().navigating.subscribe(r)}};export{yt as a,bt as b,T as i,mt as l,vt as n,_t as p};
