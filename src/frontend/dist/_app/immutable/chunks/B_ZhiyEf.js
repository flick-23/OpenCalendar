import{w as L,g as Se}from"./BDaeVcD9.js";import{S as ee,e as K,b as Te,f as C,t as A,u as Ae,c as k,w as Ke,E as ae,d as Oe,P as me,r as be,h as te,s as O,A as le,g as Ce}from"./B8oHrQjp.js";import{s as Le}from"./lz1GsiPz.js";var U=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},m=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},x,N,S,T;function ce(r){return r!==null&&typeof r=="object"}class w{constructor(e){if(x.set(this,void 0),N.set(this,void 0),e.byteLength!==w.RAW_KEY_LENGTH)throw new Error("An Ed25519 public key must be exactly 32bytes long");U(this,x,k(e),"f"),U(this,N,w.derEncode(e),"f")}static from(e){if(typeof e=="string"){const t=C(e);return this.fromRaw(t)}else if(ce(e)){const t=e;if(ce(t)&&Object.hasOwnProperty.call(t,"__derEncodedPublicKey__"))return this.fromDer(t);if(ArrayBuffer.isView(t)){const n=t;return this.fromRaw(k(n.buffer))}else{if(t instanceof ArrayBuffer)return this.fromRaw(t);if("rawKey"in t)return this.fromRaw(t.rawKey);if("derKey"in t)return this.fromDer(t.derKey);if("toDer"in t)return this.fromDer(t.toDer())}}throw new Error("Cannot construct Ed25519PublicKey from the provided key.")}static fromRaw(e){return new w(e)}static fromDer(e){return new w(this.derDecode(e))}static derEncode(e){const t=Ke(e,ae).buffer;return t.__derEncodedPublicKey__=void 0,t}static derDecode(e){const t=Oe(e,ae);if(t.length!==this.RAW_KEY_LENGTH)throw new Error("An Ed25519 public key must be exactly 32bytes long");return k(t)}get rawKey(){return m(this,x,"f")}get derKey(){return m(this,N,"f")}toDer(){return this.derKey}toRaw(){return this.rawKey}}x=new WeakMap,N=new WeakMap;w.RAW_KEY_LENGTH=32;class v extends ee{constructor(e,t){super(),S.set(this,void 0),T.set(this,void 0),U(this,S,w.from(e),"f"),U(this,T,new Uint8Array(t),"f")}static generate(e){if(e&&e.length!==32)throw new Error("Ed25519 Seed needs to be 32 bytes long.");e||(e=K.utils.randomPrivateKey()),Te(e,new Uint8Array(new Array(32).fill(0)))&&console.warn("Seed is all zeros. This is not a secure seed. Please provide a seed with sufficient entropy if this is a production environment.");const t=new Uint8Array(32);for(let i=0;i<32;i++)t[i]=new Uint8Array(e)[i];const n=K.getPublicKey(t);return v.fromKeyPair(n,t)}static fromParsedJson(e){const[t,n]=e;return new v(w.fromDer(C(t)),C(n))}static fromJSON(e){const t=JSON.parse(e);if(Array.isArray(t)){if(typeof t[0]=="string"&&typeof t[1]=="string")return this.fromParsedJson([t[0],t[1]]);throw new Error("Deserialization error: JSON must have at least 2 items.")}throw new Error(`Deserialization error: Invalid JSON type for string: ${JSON.stringify(e)}`)}static fromKeyPair(e,t){return new v(w.fromRaw(e),t)}static fromSecretKey(e){const t=K.getPublicKey(new Uint8Array(e));return v.fromKeyPair(t,e)}toJSON(){return[A(m(this,S,"f").toDer()),A(m(this,T,"f"))]}getKeyPair(){return{secretKey:m(this,T,"f"),publicKey:m(this,S,"f")}}getPublicKey(){return m(this,S,"f")}async sign(e){const t=new Uint8Array(e),n=Ae(K.sign(t,m(this,T,"f").slice(0,32)));return Object.defineProperty(n,"__signature__",{enumerable:!1,value:void 0}),n}static verify(e,t,n){const[i,o,a]=[e,t,n].map(s=>(typeof s=="string"&&(s=C(s)),s instanceof Uint8Array&&(s=k(s.buffer)),new Uint8Array(s)));return K.verify(i,o,a)}}S=new WeakMap,T=new WeakMap;class re extends Error{constructor(e){super(e),this.message=e,Object.setPrototypeOf(this,re.prototype)}}function ue(r){if(typeof global<"u"&&global.crypto&&global.crypto.subtle)return global.crypto.subtle;if(r)return r;if(typeof crypto<"u"&&crypto.subtle)return crypto.subtle;throw new re("Global crypto was not available and none was provided. Please inlcude a SubtleCrypto implementation. See https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto")}class M extends ee{constructor(e,t,n){super(),this._keyPair=e,this._derKey=t,this._subtleCrypto=n}static async generate(e){const{extractable:t=!1,keyUsages:n=["sign","verify"],subtleCrypto:i}=e??{},o=ue(i),a=await o.generateKey({name:"ECDSA",namedCurve:"P-256"},t,n),s=await o.exportKey("spki",a.publicKey);return new this(a,s,o)}static async fromKeyPair(e,t){const n=ue(t),i=await n.exportKey("spki",e.publicKey);return new M(e,i,n)}getKeyPair(){return this._keyPair}getPublicKey(){const e=this._derKey,t=Object.create(this._keyPair.publicKey);return t.toDer=function(){return e},t}async sign(e){const t={name:"ECDSA",hash:{name:"SHA-256"}};return await this._subtleCrypto.sign(t,this._keyPair.privateKey,e)}}var ke=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},D=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},y;class xe{constructor(e){y.set(this,void 0),ke(this,y,e,"f")}get rawKey(){return D(this,y,"f").rawKey}get derKey(){return D(this,y,"f").derKey}toDer(){return D(this,y,"f").toDer()}getPublicKey(){return D(this,y,"f")}getPrincipal(){if(!D(this,y,"f").rawKey)throw new Error("Cannot get principal from a public key without a raw key.");return me.fromUint8Array(new Uint8Array(D(this,y,"f").rawKey))}transformRequest(){return Promise.reject("Not implemented. You are attempting to use a partial identity to sign calls, but this identity only has access to the public key.To sign calls, use a DelegationIdentity instead.")}}y=new WeakMap;var Ne=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},Re=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},Be=function(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(r);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(r,n[i])&&(t[n[i]]=r[n[i]]);return t},R;const je=new TextEncoder().encode("ic-request-auth-delegation"),Ue=new TextEncoder().encode(`
ic-request`);function J(r){if(typeof r!="string"||r.length<64)throw new Error("Invalid public key.");return C(r)}class ne{constructor(e,t,n){this.pubkey=e,this.expiration=t,this.targets=n}toCBOR(){return O.value.map(Object.assign({pubkey:O.value.bytes(this.pubkey),expiration:O.value.u64(this.expiration.toString(16),16)},this.targets&&{targets:O.value.array(this.targets.map(e=>O.value.bytes(te(e.toUint8Array()))))}))}toJSON(){return Object.assign({expiration:this.expiration.toString(16),pubkey:A(this.pubkey)},this.targets&&{targets:this.targets.map(e=>e.toHex())})}}async function Me(r,e,t,n){const i=new ne(e.toDer(),BigInt(+t)*BigInt(1e6),n),o=new Uint8Array([...je,...new Uint8Array(be(Object.assign({},i)))]),a=await r.sign(te(o));return{delegation:i,signature:a}}class W{constructor(e,t){this.delegations=e,this.publicKey=t}static async create(e,t,n=new Date(Date.now()+15*60*1e3),i={}){var o,a;const s=await Me(e,t,n,i.targets);return new W([...((o=i.previous)===null||o===void 0?void 0:o.delegations)||[],s],((a=i.previous)===null||a===void 0?void 0:a.publicKey)||e.getPublicKey().toDer())}static fromJSON(e){const{publicKey:t,delegations:n}=typeof e=="string"?JSON.parse(e):e;if(!Array.isArray(n))throw new Error("Invalid delegations.");const i=n.map(o=>{const{delegation:a,signature:s}=o,{pubkey:l,expiration:c,targets:f}=a;if(f!==void 0&&!Array.isArray(f))throw new Error("Invalid targets.");return{delegation:new ne(J(l),BigInt("0x"+c),f&&f.map(u=>{if(typeof u!="string")throw new Error("Invalid target.");return me.fromHex(u)})),signature:J(s)}});return new this(i,J(t))}static fromDelegations(e,t){return new this(e,t)}toJSON(){return{delegations:this.delegations.map(e=>{const{delegation:t,signature:n}=e,{targets:i}=t;return{delegation:Object.assign({expiration:t.expiration.toString(16),pubkey:A(t.pubkey)},i&&{targets:i.map(o=>o.toHex())}),signature:A(n)}}),publicKey:A(this.publicKey)}}}class de extends ee{constructor(e,t){super(),this._inner=e,this._delegation=t}static fromDelegation(e,t){return new this(e,t)}getDelegation(){return this._delegation}getPublicKey(){return{derKey:this._delegation.publicKey,toDer:()=>this._delegation.publicKey}}sign(e){return this._inner.sign(e)}async transformRequest(e){const{body:t}=e,n=Be(e,["body"]),i=await be(t);return Object.assign(Object.assign({},n),{body:{content:t,sender_sig:await this.sign(te(new Uint8Array([...Ue,...new Uint8Array(i)]))),sender_delegation:this._delegation.delegations,sender_pubkey:this._delegation.publicKey}})}}class F extends xe{constructor(e,t){super(e),R.set(this,void 0),Ne(this,R,t,"f")}get delegation(){return Re(this,R,"f")}static fromDelegation(e,t){return new F(e,t)}}R=new WeakMap;function We(r,e){for(const{delegation:n}of r.delegations)if(+new Date(Number(n.expiration/BigInt(1e6)))<=+Date.now())return!1;const t=[];for(const n of t){const i=n.toText();for(const{delegation:o}of r.delegations){if(o.targets===void 0)continue;let a=!0;for(const s of o.targets)if(s.toText()===i){a=!1;break}if(a)return!1}}return!0}var fe;(function(r){r[r.ECDSA_WITH_SHA256=-7]="ECDSA_WITH_SHA256"})(fe||(fe={}));const he=["mousedown","mousemove","keydown","touchstart","wheel"];class ge{constructor(e={}){var t;this.callbacks=[],this.idleTimeout=10*60*1e3,this.timeoutID=void 0;const{onIdle:n,idleTimeout:i=10*60*1e3}=e||{};this.callbacks=n?[n]:[],this.idleTimeout=i;const o=this._resetTimer.bind(this);window.addEventListener("load",o,!0),he.forEach(function(s){document.addEventListener(s,o,!0)});const a=(s,l)=>{let c;return(...f)=>{const u=this,g=function(){c=void 0,s.apply(u,f)};clearTimeout(c),c=window.setTimeout(g,l)}};if(e!=null&&e.captureScroll){const s=a(o,(t=e==null?void 0:e.scrollDebounce)!==null&&t!==void 0?t:100);window.addEventListener("scroll",s,!0)}o()}static create(e={}){return new this(e)}registerCallback(e){this.callbacks.push(e)}exit(){clearTimeout(this.timeoutID),window.removeEventListener("load",this._resetTimer,!0);const e=this._resetTimer.bind(this);he.forEach(function(t){document.removeEventListener(t,e,!0)}),this.callbacks.forEach(t=>t())}_resetTimer(){const e=this.exit.bind(this);window.clearTimeout(this.timeoutID),this.timeoutID=window.setTimeout(e,this.idleTimeout)}}const Fe=(r,e)=>e.some(t=>r instanceof t);let ye,we;function He(){return ye||(ye=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Je(){return we||(we=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const _e=new WeakMap,Q=new WeakMap,ve=new WeakMap,V=new WeakMap,ie=new WeakMap;function Ve(r){const e=new Promise((t,n)=>{const i=()=>{r.removeEventListener("success",o),r.removeEventListener("error",a)},o=()=>{t(E(r.result)),i()},a=()=>{n(r.error),i()};r.addEventListener("success",o),r.addEventListener("error",a)});return e.then(t=>{t instanceof IDBCursor&&_e.set(t,r)}).catch(()=>{}),ie.set(e,r),e}function ze(r){if(Q.has(r))return;const e=new Promise((t,n)=>{const i=()=>{r.removeEventListener("complete",o),r.removeEventListener("error",a),r.removeEventListener("abort",a)},o=()=>{t(),i()},a=()=>{n(r.error||new DOMException("AbortError","AbortError")),i()};r.addEventListener("complete",o),r.addEventListener("error",a),r.addEventListener("abort",a)});Q.set(r,e)}let X={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return Q.get(r);if(e==="objectStoreNames")return r.objectStoreNames||ve.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return E(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function Ge(r){X=r(X)}function Ye(r){return r===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const n=r.call(z(this),e,...t);return ve.set(n,e.sort?e.sort():[e]),E(n)}:Je().includes(r)?function(...e){return r.apply(z(this),e),E(_e.get(this))}:function(...e){return E(r.apply(z(this),e))}}function $e(r){return typeof r=="function"?Ye(r):(r instanceof IDBTransaction&&ze(r),Fe(r,He())?new Proxy(r,X):r)}function E(r){if(r instanceof IDBRequest)return Ve(r);if(V.has(r))return V.get(r);const e=$e(r);return e!==r&&(V.set(r,e),ie.set(e,r)),e}const z=r=>ie.get(r);function qe(r,e,{blocked:t,upgrade:n,blocking:i,terminated:o}={}){const a=indexedDB.open(r,e),s=E(a);return n&&a.addEventListener("upgradeneeded",l=>{n(E(a.result),l.oldVersion,l.newVersion,E(a.transaction),l)}),t&&a.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),s.then(l=>{o&&l.addEventListener("close",()=>o()),i&&l.addEventListener("versionchange",c=>i(c.oldVersion,c.newVersion,c))}).catch(()=>{}),s}const Qe=["get","getKey","getAll","getAllKeys","count"],Xe=["put","add","delete","clear"],G=new Map;function pe(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(G.get(e))return G.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,i=Xe.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(i||Qe.includes(t)))return;const o=async function(a,...s){const l=this.transaction(a,i?"readwrite":"readonly");let c=l.store;return n&&(c=c.index(s.shift())),(await Promise.all([c[t](...s),i&&l.done]))[0]};return G.set(e,o),o}Ge(r=>({...r,get:(e,t,n)=>pe(e,t)||r.get(e,t,n),has:(e,t)=>!!pe(e,t)||r.has(e,t)}));const Ee="auth-client-db",Ie="ic-keyval",Ze=async(r=Ee,e=Ie,t)=>(Pe&&(localStorage!=null&&localStorage.getItem(_))&&(localStorage.removeItem(_),localStorage.removeItem(b)),await qe(r,t,{upgrade:n=>{n.objectStoreNames.contains(e)&&n.clear(e),n.createObjectStore(e)}}));async function et(r,e,t){return await r.get(e,t)}async function tt(r,e,t,n){return await r.put(e,n,t)}async function rt(r,e,t){return await r.delete(e,t)}class oe{constructor(e,t){this._db=e,this._storeName=t}static async create(e){const{dbName:t=Ee,storeName:n=Ie,version:i=st}=e??{},o=await Ze(t,n,i);return new oe(o,n)}async set(e,t){return await tt(this._db,this._storeName,e,t)}async get(e){var t;return(t=await et(this._db,this._storeName,e))!==null&&t!==void 0?t:null}async remove(e){return await rt(this._db,this._storeName,e)}}var nt=function(r,e,t,n,i){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?i.call(r,t):i?i.value=t:e.set(r,t),t},it=function(r,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(r):n?n.value:e.get(r)},B;const b="identity",_="delegation",ot="iv",st=1,Pe=typeof window<"u";class at{constructor(e="ic-",t){this.prefix=e,this._localStorage=t}get(e){return Promise.resolve(this._getLocalStorage().getItem(this.prefix+e))}set(e,t){return this._getLocalStorage().setItem(this.prefix+e,t),Promise.resolve()}remove(e){return this._getLocalStorage().removeItem(this.prefix+e),Promise.resolve()}_getLocalStorage(){if(this._localStorage)return this._localStorage;const e=typeof window>"u"?typeof global>"u"?typeof self>"u"?void 0:self.localStorage:global.localStorage:window.localStorage;if(!e)throw new Error("Could not find local storage.");return e}}class lt{constructor(e){B.set(this,void 0),nt(this,B,e??{},"f")}get _db(){return new Promise(e=>{if(this.initializedDb){e(this.initializedDb);return}oe.create(it(this,B,"f")).then(t=>{this.initializedDb=t,e(t)})})}async get(e){return await(await this._db).get(e)}async set(e,t){await(await this._db).set(e,t)}async remove(e){await(await this._db).remove(e)}}B=new WeakMap;const ct="https://identity.internetcomputer.org",ut="#authorize",Y="ECDSA",$="Ed25519",dt=500,ft="UserInterrupt";class ht{constructor(e,t,n,i,o,a,s,l){this._identity=e,this._key=t,this._chain=n,this._storage=i,this.idleManager=o,this._createOptions=a,this._idpWindow=s,this._eventHandler=l,this._registerDefaultIdleCallback()}static async create(e={}){var t,n,i;const o=(t=e.storage)!==null&&t!==void 0?t:new lt,a=(n=e.keyType)!==null&&n!==void 0?n:Y;let s=null;if(e.identity)s=e.identity;else{let u=await o.get(b);if(!u&&Pe)try{const g=new at,H=await g.get(_),se=await g.get(b);H&&se&&a===Y&&(console.log("Discovered an identity stored in localstorage. Migrating to IndexedDB"),await o.set(_,H),await o.set(b,se),u=H,await g.remove(_),await g.remove(b))}catch(g){console.error("error while attempting to recover localstorage: "+g)}if(u)try{typeof u=="object"?a===$&&typeof u=="string"?s=await v.fromJSON(u):s=await M.fromKeyPair(u):typeof u=="string"&&(s=v.fromJSON(u))}catch{}}let l=new le,c=null;if(s)try{const u=await o.get(_);if(typeof u=="object"&&u!==null)throw new Error("Delegation chain is incorrectly stored. A delegation chain should be stored as a string.");e.identity?l=e.identity:u&&(c=W.fromJSON(u),We(c)?"toDer"in s?l=F.fromDelegation(s,c):l=de.fromDelegation(s,c):(await q(o),s=null))}catch(u){console.error(u),await q(o),s=null}let f;return!((i=e.idleOptions)===null||i===void 0)&&i.disableIdle?f=void 0:(c||e.identity)&&(f=ge.create(e.idleOptions)),s||(a===$?(s=await v.generate(),await o.set(b,JSON.stringify(s.toJSON()))):(e.storage&&a===Y&&console.warn(`You are using a custom storage provider that may not support CryptoKey storage. If you are using a custom storage provider that does not support CryptoKey storage, you should use '${$}' as the key type, as it can serialize to a string`),s=await M.generate(),await o.set(b,s.getKeyPair()))),new this(l,s,c,o,f,e)}_registerDefaultIdleCallback(){var e,t;const n=(e=this._createOptions)===null||e===void 0?void 0:e.idleOptions;!(n!=null&&n.onIdle)&&!(n!=null&&n.disableDefaultIdleCallback)&&((t=this.idleManager)===null||t===void 0||t.registerCallback(()=>{this.logout(),location.reload()}))}async _handleSuccess(e,t){var n,i;const o=e.delegations.map(c=>({delegation:new ne(c.delegation.pubkey,c.delegation.expiration,c.delegation.targets),signature:c.signature.buffer})),a=W.fromDelegations(o,e.userPublicKey.buffer),s=this._key;if(!s)return;this._chain=a,"toDer"in s?this._identity=F.fromDelegation(s,this._chain):this._identity=de.fromDelegation(s,this._chain),(n=this._idpWindow)===null||n===void 0||n.close();const l=(i=this._createOptions)===null||i===void 0?void 0:i.idleOptions;!this.idleManager&&!(l!=null&&l.disableIdle)&&(this.idleManager=ge.create(l),this._registerDefaultIdleCallback()),this._removeEventListener(),delete this._idpWindow,this._chain&&await this._storage.set(_,JSON.stringify(this._chain.toJSON())),t==null||t(e)}getIdentity(){return this._identity}async isAuthenticated(){return!this.getIdentity().getPrincipal().isAnonymous()&&this._chain!==null}async login(e){var t,n,i,o;const a=BigInt(8)*BigInt(36e11),s=new URL(((t=e==null?void 0:e.identityProvider)===null||t===void 0?void 0:t.toString())||ct);s.hash=ut,(n=this._idpWindow)===null||n===void 0||n.close(),this._removeEventListener(),this._eventHandler=this._getEventHandler(s,Object.assign({maxTimeToLive:(i=e==null?void 0:e.maxTimeToLive)!==null&&i!==void 0?i:a},e)),window.addEventListener("message",this._eventHandler),this._idpWindow=(o=window.open(s.toString(),"idpWindow",e==null?void 0:e.windowOpenerFeatures))!==null&&o!==void 0?o:void 0;const l=()=>{this._idpWindow&&(this._idpWindow.closed?this._handleFailure(ft,e==null?void 0:e.onError):setTimeout(l,dt))};l()}_getEventHandler(e,t){return async n=>{var i,o,a;if(n.origin!==e.origin)return;const s=n.data;switch(s.kind){case"authorize-ready":{const l=Object.assign({kind:"authorize-client",sessionPublicKey:new Uint8Array((i=this._key)===null||i===void 0?void 0:i.getPublicKey().toDer()),maxTimeToLive:t==null?void 0:t.maxTimeToLive,allowPinAuthentication:t==null?void 0:t.allowPinAuthentication,derivationOrigin:(o=t==null?void 0:t.derivationOrigin)===null||o===void 0?void 0:o.toString()},t==null?void 0:t.customValues);(a=this._idpWindow)===null||a===void 0||a.postMessage(l,e.origin);break}case"authorize-client-success":try{await this._handleSuccess(s,t==null?void 0:t.onSuccess)}catch(l){this._handleFailure(l.message,t==null?void 0:t.onError)}break;case"authorize-client-failure":this._handleFailure(s.text,t==null?void 0:t.onError);break}}}_handleFailure(e,t){var n;(n=this._idpWindow)===null||n===void 0||n.close(),t==null||t(e),this._removeEventListener(),delete this._idpWindow}_removeEventListener(){this._eventHandler&&window.removeEventListener("message",this._eventHandler),this._eventHandler=void 0}async logout(e={}){if(await q(this._storage),this._identity=new le,this._chain=null,e.returnTo)try{window.history.pushState({},"",e.returnTo)}catch{window.location.href=e.returnTo}}}async function q(r){await r.remove(b),await r.remove(_),await r.remove(ot)}const I=L(!1),p=L(null),P=L(null),j=L(null),d=L(null);let h=null;const Z=async()=>{const r=Se(p);if(!r){d.set(null),console.log("No identity found, cannot fetch profile.");return}try{console.log("Fetching user profile...");const t=await(await Ce(r)).get_my_profile();Array.isArray(t)&&t.length>0?(d.set(t[0]||null),console.log("User profile fetched and set:",t[0])):t&&!Array.isArray(t)?(d.set(t),console.log("User profile fetched and set:",t)):(d.set(null),console.log("No profile data returned or profile is empty."))}catch(e){console.error("Error fetching user profile:",e),d.set(null)}},gt=async()=>{if(h){console.log("AuthClient already initialized, checking authentication status...");const r=await h.isAuthenticated(),e=r?h.getIdentity():null;I.set(r),p.set(e),P.set(e?e.getPrincipal():null),j.set(h),r?(console.log("User is already authenticated, fetching profile..."),await Z()):d.set(null);return}try{console.log("Creating AuthClient...");const r=await ht.create();h=r,j.set(r);const e=await r.isAuthenticated();if(I.set(e),e){console.log("User is authenticated, setting up identity...");const t=r.getIdentity();p.set(t),P.set(t.getPrincipal()),console.log("Principal:",t.getPrincipal().toString()),await Z()}else console.log("User is not authenticated"),d.set(null)}catch(r){throw console.error("Error initializing auth client:",r),I.set(!1),p.set(null),P.set(null),j.set(null),d.set(null),r}},yt=()=>"http://127.0.0.1:8000/?canisterId=ufxgi-4p777-77774-qaadq-cai",bt=async()=>{if(!h&&(await gt(),!h)){console.error("AuthClient not initialized, cannot login.");return}const r=h;try{const e=yt();console.log("Attempting to login with Internet Identity URL:",e),await new Promise((t,n)=>{r.login({identityProvider:e,onSuccess:async()=>{console.log("Login successful");const i=r.getIdentity();p.set(i),P.set(i.getPrincipal()),I.set(!0),j.set(r),await Z(),t()},onError:i=>{console.error("Login failed:",i),I.set(!1),p.set(null),P.set(null),d.set(null),n(i)}})})}catch(e){throw console.error("Error during login process:",e),I.set(!1),p.set(null),P.set(null),d.set(null),e}},_t=async()=>{if(!h){console.error("AuthClient not initialized, cannot logout.");return}try{console.log("Logging out..."),await h.logout(),I.set(!1),p.set(null),P.set(null),d.set(null),console.log("Logout successful")}catch(r){throw console.error("Error during logout:",r),I.set(!1),p.set(null),P.set(null),d.set(null),r}},De=()=>{const r=Le;return{page:{subscribe:r.page.subscribe},navigating:{subscribe:r.navigating.subscribe},updated:r.updated}},vt={subscribe(r){return De().page.subscribe(r)}},Et={subscribe(r){return De().navigating.subscribe(r)}};export{gt as a,_t as b,I as i,bt as l,Et as n,vt as p};
